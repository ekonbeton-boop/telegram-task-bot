{% extends "base.html" %}

{% block content %}
<h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
<a href="/export" class="btn btn-success mb-3">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
<div id="stats" class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h5>–í—Å–µ–≥–æ –∑–∞–¥–∞—á</h5>
                <h3 id="total">‚Äî</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <h5>–û—Ç–∫—Ä—ã—Ç–æ</h5>
                <h3 id="open">‚Äî</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h5>–ó–∞–∫—Ä—ã—Ç–æ</h5>
                <h3 id="closed">‚Äî</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h5>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</h5>
                <h3 id="avg_time">‚Äî</h3>
            </div>
        </div>
    </div>
</div>

<h4>üìà –¢–æ–ø-5 —Å–∞–º—ã—Ö –¥–æ–ª–≥–∏—Ö –∑–∞–¥–∞—á</h4>
<ul id="top-tasks">
    <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è JS -->
</ul>

<hr>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="btn-group mb-3" role="group">
    <a href="/" class="btn btn-outline-secondary {% if filter == 'all' %}active{% endif %}">–í—Å–µ</a>
    <a href="/?filter=open" class="btn btn-outline-warning {% if filter == 'open' %}active{% endif %}">–û—Ç–∫—Ä—ã—Ç—ã–µ</a>
    <a href="/?filter=closed" class="btn btn-outline-success {% if filter == 'closed' %}active{% endif %}">–ó–∞–∫—Ä—ã—Ç—ã–µ</a>
</div>

<!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
<div class="card mb-4">
    <div class="card-body">
        <h5>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h5>
        <form method="POST" action="/add">
            <div class="input-group">
                <input type="text" name="description" class="form-control" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
                <button class="btn btn-primary" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
<h4>üìã –ó–∞–¥–∞—á–∏</h4>
{% if tasks %}
    <div class="list-group">
    {% for task in tasks %}
        <div class="list-group-item">
            <div class="d-flex justify-content-between">
                <div>
                    <strong>üîñ ID: {{ task['id'] }}</strong><br>
                    <span class="fw-bold">{{ task['description'] }}</span><br>
                    <small class="text-muted">–°–æ–∑–¥–∞–Ω–∞: {{ task['created_at'] }}</small>
                    {% if task['is_closed'] %}
                        <br><span class="badge bg-success">‚úÖ –ó–∞–∫—Ä—ã—Ç–∞</span>
                        <br><small>–ó–∞–∫—Ä—ã—Ç–∞: {{ task['closed_at'] }} | ‚è±Ô∏è {{ task['time_spent'] }} —á.</small>
                    {% else %}
                        <br><span class="badge bg-warning text-dark">‚è≥ –û—Ç–∫—Ä—ã—Ç–∞</span>
                    {% endif %}
                </div>
                <div class="d-flex flex-column gap-1">
                    {% if not task['is_closed'] %}
                        <button class="btn btn-success btn-sm" onclick="closeTask({{ task['id'] }})">‚úÖ –ó–∞–∫—Ä—ã—Ç—å</button>
                    {% endif %}
                    <button class="btn btn-outline-primary btn-sm" onclick="editTask({{ task['id'] }}, '{{ task['description']|replace("'", "\\'") }}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteTask({{ task['id'] }})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        </div>
    {% endfor %}
    </div>
{% else %}
    <div class="alert alert-info">üì≠ –ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç.</div>
{% endif %}

<script>
    $(document).ready(function() {
        $.get('/api/stats', function(data) {
            $('#total').text(data.total);
            $('#open').text(data.open);
            $('#closed').text(data.closed);
            $('#avg_time').text(data.avg_time + ' —á.');

            let topList = $('#top-tasks');
            topList.empty();
            if (data.top_long_tasks.length > 0) {
                let html = '<ul>';
                data.top_long_tasks.forEach(item => {
                    html += `<li>${item.description} ‚Äî <strong>${item.time_spent} —á.</strong></li>`;
                });
                html += '</ul>';
                topList.html(html);
            } else {
                topList.text('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
            }
        });
    });
</script>
{% endblock %}
